<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=google-site-verification content="X6gTMGCy1-_vb5i3aja3ZZyzPY3raiKRJp4VIhOAX24"><meta name=msvalidate.01 content="CDE7502649B75529BD0FCFE89B056E38"><title>[认证&授权] 04 OIDC(OpenId Connect)身份认证(核心部分) - Timetombs</title>
<link rel=icon type=image/svg href=/favicon.svg><link rel=stylesheet href=https://s4.zstatic.net/ajax/libs/normalize/8.0.1/normalize.min.css crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://s4.zstatic.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css crossorigin=anonymous referrerpolicy=no-referrer><link href='/asset/blog.css?time=2025-10-26T19%3a03%3a29Z%2b08%3a00' rel=stylesheet type=text/css><script src=https://s4.zstatic.net/npm/currency.js@2.0.4/dist/currency.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://s4.zstatic.net/ajax/libs/moment.js/2.30.1/moment.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src='/asset/blog.js?time=2025-10-26T19%3a03%3a29Z%2b08%3a00' type=application/javascript></script><script type=text/javascript>blog.isMobile()&&document.write('<link href="/asset/blog.mobile.css?time=2025-10-26T19%3A03%3A29Z%2B08%3A00" rel="stylesheet">')</script></head><body><div id=horizontal-progress class=horizontal-progress></div><aside id=toc class=toc><section class=toc-header><a class=toc-page-title href=/authentication-and-authorization/ target=_blank>[认证&授权]</a></section><section class=toc-page><a class=toc-page-title href=/authentication-and-authorization/01-oauth2-authorization/ target=_blank>[认证&授权] 01 OAuth2授权</a></section><section class=toc-page><a class=toc-page-title href=/authentication-and-authorization/02-oauth2-extensions-protocol-and-json-web-token/ target=_blank>[认证&授权] 02 OAuth2授权(续) & JWT(JSON Web Token)</a></section><section class=toc-page><a class=toc-page-title href=/authentication-and-authorization/03-user-authentication-with-oauth2/ target=_blank>[认证&授权] 03 使用OAuth2进行用户认证(译)</a></section><section class="toc-page selected"><span class=toc-page-title>[认证&授权] 04 OIDC(OpenId Connect)身份认证(核心部分)</span><nav id=TableOfContents><ul><li><a href=#what-is-oidc>1 什么是OIDC？</a></li><li><a href=#oidc-protocol-suite>2 OIDC 协议族</a></li><li><a href=#oidc-core-concept>3 OIDC 核心概念</a><ul><li><a href=#oidc-core-terminology>3.1 OIDC 主要术语</a></li><li><a href=#oidc-workflow>3.2 OIDC 工作流程</a></li><li><a href=#oidc-id-token>3.3 ID Token</a></li><li><a href=#authentication>3.4 认证</a><ul><li><a href=#based-on-authorization-code-authentication-request>3.4.1 基于Authorization Code的认证请求</a></li><li><a href=#based-on-authorization-code-authentication-response>3.4.2 基于Authorization Code的认证请求的响应</a></li><li><a href=#get-id-token>3.4.3 获取ID Token</a></li><li><a href=#implicit-flow-and-hybrid-flow>3.4.4 Implicit Flow和Hybrid Flow</a></li></ul></li><li><a href=#5.userinfo-endpoint>3.5 UserInfo Endpoint</a></li></ul></li><li><a href=#summary>4 总结</a></li><li><a href=#example>5 示例</a></li><li><a href=#6-参考>6 参考</a></li></ul></nav></section><section class=toc-page><a class=toc-page-title href=/authentication-and-authorization/05-openid-connect-extension/ target=_blank>[认证&授权] 05 OIDC(OpenId Connect)身份认证(扩展部分)</a></section><section class=toc-page><a class=toc-page-title href=/authentication-and-authorization/06-permission-based-access-control/ target=_blank>[认证&授权] 06 Permission Based Access Control</a></section><script type=text/javascript>blog.isPC()&&blog.toggleToc()</script></aside><main class=main><header class=header><hgroup class=header-hgroup><h1 class=header-hgroup-title><a href=/>Timetombs</a></h1><h2 class=header-hgroup-subtitle>泛义的工具是文明的基础，而确指的工具却是愚人的器物</h2></hgroup><nav class=header-nav><a class=header-nav-item href=/topic/ title=专题 target=_self><i class="fa fa-folder"></i>专题</a>
<a class=header-nav-item href=/tag/ title=标签 target=_self><i class="fa fa-tags"></i>标签</a>
<a class=header-nav-item href=/archive/ title=归档 target=_self><i class="fa fa-archive"></i>归档</a>
<a class=header-nav-item href=https://linianhui.cnblogs.com title=博客园 target=_black><img src=/asset/cnblogs.favicon.svg>博客园</a>
<a class=header-nav-item href=https://github.com/linianhui/blog title=GitHub target=_black><i class="fa fa-github"></i>GitHub</a></nav><div class=header-stats><div class=stats><span>共
<i>66<sub>h</sub>
</i>/
<i>118<sub>a</sub>
</i>篇</span><div class=stats-date>，更新于 2025-10-26T19:03:29Z+08:00 by &nbsp;
<a class=git-commit href=https://github.com/linianhui/blog/commit/2fac07e818d6d4ad6b78781efea82c28769c8c02 target=_blank><i class="fa fa-code-fork"></i>2fac07e</a></div></div><form class=search method=GET target=_blank action=https://www.bing.com/search><input name=q class=search-input type=search placeholder=search... results=5 onkeypress="search_param.value=search_param_site.value+this.value">
<input id=search_param_site type=hidden value="site:linianhui.github.io ">
<input name=q id=search_param type=hidden></form></div></header><main class=content><article class=article><h1 class=article-title>[认证&授权] 04 OIDC(OpenId Connect)身份认证(核心部分)
<i class="fa fa-fire article-title-weight" aria-hidden=true title=顶置></i></h1><div class=article-copyright><span>版权声明 - </span><a href=/copyright/cc target=_blank>CC BY-NC-SA 4.0</a></div><section class=article-meta><section class=article-date>2017-05-30 09:18，约6762字，阅读约14分钟</section><section class=article-topics><a class=article-topic href=/authentication-and-authorization/ title=[认证&授权] target=_blank><i class="fa fa-folder"></i>[认证&授权]</a></section><section class=article-tags><a class=article-tag href=/tag/id-token target=_blank><i class="fa fa-tag"></i>Id Token</a>
<a class=article-tag href=/tag/jwt target=_blank><i class="fa fa-tag"></i>JWT</a>
<a class=article-tag href=/tag/oauth2 target=_blank><i class="fa fa-tag"></i>OAuth2</a>
<a class=article-tag href=/tag/oidc target=_blank><i class="fa fa-tag"></i>OIDC</a>
<a class=article-tag href=/tag/op target=_blank><i class="fa fa-tag"></i>OP</a>
<a class=article-tag href=/tag/openid-connect target=_blank><i class="fa fa-tag"></i>OpenId Connect</a>
<a class=article-tag href=/tag/rp target=_blank><i class="fa fa-tag"></i>RP</a></section><section class=article-git><a class=article-git-commit href=https://github.com/linianhui/blog/commit/03e0cc08866458647d96951c1817c624518149d6 target=_blank><i class="fa fa-code-fork"></i>03e0cc0</a>
<span class=article-git-commit-subject>fix add displayed_on_home</span>
<span class=article-git-commit-time>2022-11-20 14:49</span>
<a class=article-git-source href=https://github.com/linianhui/blog/blob/main/src/authentication-and-authorization/04-openid-connect-core/index.md target=_blank><i class="fa fa-github"></i>源码</a></section></section><section class=article-content><h1 id=what-is-oidc><i id=locator-what-is-oidc class=header-locator></i>
<a href=#what-is-oidc class=article-h-a>1 什么是OIDC？</a></h1><p>看一下官方的介绍(<a href=http://openid.net/connect/ target=_blank rel="noopener norefferrer">http://openid.net/connect/</a>) :</p><blockquote><p>OpenID Connect 1.0 is a simple identity layer on top of the OAuth 2.0 protocol. It allows Clients to verify the identity of the End-User based on the authentication performed by an Authorization Server, as well as to obtain basic profile information about the End-User in an interoperable and REST-like manner.</p><p>OpenID Connect allows clients of all types, including Web-based, mobile, and JavaScript clients, to request and receive information about authenticated sessions and end-users. The specification suite is extensible, allowing participants to use optional features such as encryption of identity data, discovery of OpenID Providers, and session management, when it makes sense for them.</p></blockquote><p>简单来说 : OIDC是OpenID Connect的简称，<code>OIDC=(Identity, Authentication) + OAuth 2.0</code>。它在OAuth2上构建了一个身份层，是一个基于OAuth2协议的身份认证标准协议。我们都知道OAuth2是一个授权协议，它无法提供完善的身份认证功能(关于这一点请参考<a href=../03-user-authentication-with-oauth2/ target=_blank rel="noopener norefferrer">[认证&授权] 03 使用OAuth2进行用户认证(译)</a>)，OIDC使用OAuth2的授权服务器来为第三方客户端提供用户的身份认证，并把对应的身份认证信息传递给客户端，且可以适用于各种类型的客户端(比如服务端应用，移动APP，JS应用)，且完全兼容OAuth2，也就是说你搭建了一个OIDC的服务后，也可以当作一个OAuth2的服务来用。应用场景如图 :<br><img src=oidc-use-for.png loading=lazy decoding=auto alt="OIDC 应用场景" title="OIDC 应用场景"></p><p>OIDC已经有很多的企业在使用，比如<a href=https://developers.google.com/identity/protocols/OpenIDConnect target=_blank rel="noopener norefferrer">Google的账号认证授权体系</a>,<a href=https://docs.microsoft.com/en-us/azure/active-directory/develop/active-directory-protocols-openid-connect-code target=_blank rel="noopener norefferrer">Microsoft的账号体系</a>当然这些企业有的也是OIDC背后的推动者。除了这些之外，有很多各个语言版本的开源服务端组件，客户端组件等等(<a href=http://openid.net/developers/certified/ target=_blank rel="noopener norefferrer">http://openid.net/developers/certified/</a>)。</p><p>理解OIDC的前提是需要理解OAuth2，这里假设大家都有OAuth2的基础，不清楚的可以先阅读本系列的前几篇OAuth2的文章。</p><h1 id=oidc-protocol-suite><i id=locator-oidc-protocol-suite class=header-locator></i>
<a href=#oidc-protocol-suite class=article-h-a>2 OIDC 协议族</a></h1><p>OIDC本身是有多个规范构成，其中包含一个核心的规范，多个可选支持的规范来提供扩展支持，简单的来看一下 :</p><ol><li><a href=http://openid.net/specs/openid-connect-core-1_0.html target=_blank rel="noopener norefferrer">Core</a> : 必选。定义OIDC的核心功能，在OAuth 2.0之上构建身份认证，以及如何使用Claims来传递用户的信息。</li><li><a href=http://openid.net/specs/openid-connect-discovery-1_0.html target=_blank rel="noopener norefferrer">Discovery</a> : 可选。发现服务，使客户端可以动态的获取OIDC服务相关的元数据描述信息(比如支持那些规范，接口地址是什么等等)。</li><li><a href=http://openid.net/specs/openid-connect-registration-1_0.html target=_blank rel="noopener norefferrer">Dynamic Registration</a> : 可选。动态注册服务，使客户端可以动态的注册到OIDC的OP(这个缩写后面会解释)。</li><li><a href=http://openid.net/specs/oauth-v2-multiple-response-types-1_0.html target=_blank rel="noopener norefferrer">OAuth 2.0 Multiple Response Types</a> : 可选。针对OAuth2的扩展，提供几个新的response_type。</li><li><a href=http://openid.net/specs/oauth-v2-form-post-response-mode-1_0.html target=_blank rel="noopener norefferrer">OAuth 2.0 Form Post Response Mode</a> : 可选。针对OAuth2的扩展，OAuth2回传信息给客户端是通过URL的querystring和fragment这两种方式，这个扩展标准提供了一基于form表单的形式把数据post给客户端的机制。</li><li><a href=http://openid.net/specs/openid-connect-session-1_0.html target=_blank rel="noopener norefferrer">Session Management</a> : 可选。Session管理，用于规范OIDC服务如何管理Session信息。</li><li><a href=http://openid.net/specs/openid-connect-frontchannel-1_0.html target=_blank rel="noopener norefferrer">Front-Channel Logout</a> : 可选。基于前端的注销机制，使得RP(这个缩写后面会解释)可以不使用OP的iframe来退出。</li><li><a href=http://openid.net/specs/openid-connect-backchannel-1_0.html target=_blank rel="noopener norefferrer">Back-Channel Logout</a> : 可选。基于后端的注销机制，定义了RP和OP直接如何通信来完成注销。</li></ol><p>除了上面这8个之外，还有其他的正在制定中的扩展。看起来是挺多的，不要被吓到，其实并不是很复杂，除了Core核心规范内容多一点之外，另外7个都是很简单且简短的规范，另外Core是基于OAuth2的，也就是说其中很多东西在复用OAuth2，所以说你理解了OAuth2之后，OIDC就是非常容易理解的了，我们这里就只关注OIDC引入了哪些新的东西(Core，其余7个可选规范不做介绍，但是可能会提及到)。千言万语都不如一张图，没图你说个***。<br><img src=oidc-protocol-suite.png loading=lazy decoding=auto alt="OIDC 协议族" title="OIDC 协议族"></p><p>上图是官方给出的一个OIDC组成结构图，我们暂时只关注Core的部分，其他的部分了解是什么东西就可以了，当作黑盒来用。就像当初的AJAX一样，它其实并不是一个新的技术，而是结合很多已有的技术，按照规范的方式组合起来，就是AJAX。同理，OIDC也不是新技术，它主要是借鉴OpenId的身份标识，OAuth2的授权和JWT包装数据的方式，把这些技术融合在一起就是OIDC。</p><h1 id=oidc-core-concept><i id=locator-oidc-core-concept class=header-locator></i>
<a href=#oidc-core-concept class=article-h-a>3 OIDC 核心概念</a></h1><p>OAuth2提供了Access Token来解决授权第三方客户端访问受保护资源的问题；OIDC在这个基础上提供了ID Token来解决第三方客户端标识用户身份认证的问题。OIDC的核心在于在OAuth2的授权流程中，一并提供用户的身份认证信息(ID Token)给到第三方客户端，ID Token使用JWT格式来包装，得益于JWT(<a href=../02-oauth2-extensions-protocol-and-json-web-token/#json-web-token target=_blank rel="noopener norefferrer">JSON Web Token</a>)的自包含性，紧凑性以及防篡改机制，使得ID Token可以安全的传递给第三方客户端程序并且容易被验证。此外还提供了UserInfo的接口，用户获取用户的更完整的信息。</p><h2 id=oidc-core-terminology><i id=locator-oidc-core-terminology class=header-locator></i>
<a href=#oidc-core-terminology class=article-h-a>3.1 OIDC 主要术语</a></h2><p>主要的术语以及概念介绍(完整术语参见<a href=http://openid.net/specs/openid-connect-core-1_0.html#Terminology target=_blank rel="noopener norefferrer">http://openid.net/specs/openid-connect-core-1_0.html#Terminology</a>) :</p><ol><li><code>EU</code> : End User : 一个人类用户。</li><li><code>RP</code> : Relying Party , 用来代指OAuth2中的受信任的客户端，身份认证和授权信息的消费方；</li><li><code>OP</code> : OpenID Provider，有能力提供EU认证的服务(比如OAuth2中的授权服务)，用来为RP提供EU的身份认证信息；</li><li><code>ID Token</code> : JWT格式的数据，包含EU身份认证的信息。</li><li><code>UserInfo Endpoint</code> : 用户信息接口(受OAuth2保护)，当RP使用Access Token访问时，返回授权用户的信息，此接口必须使用HTTPS。</li></ol><h2 id=oidc-workflow><i id=locator-oidc-workflow class=header-locator></i>
<a href=#oidc-workflow class=article-h-a>3.2 OIDC 工作流程</a></h2><p>从抽象的角度来看，OIDC的流程由以下5个步骤构成 :</p><ol><li><code>RP</code>发送一个认证请求给<code>OP</code>；</li><li><code>OP</code>对<code>EU</code>进行身份认证，然后提供授权；</li><li><code>OP</code>把<code>ID Token</code>和<code>Access Token</code>(需要的话)返回给RP；</li><li><code>RP</code>使用<code>Access Token</code>发送一个请求<code>UserInfo EndPoint</code>；</li><li><code>UserInfo EndPoint</code>返回<code>EU</code>的<code>Claims</code>。<br><img src=oidc-workflow.jpg loading=lazy decoding=auto alt="OIDC 工作流程 " title="OIDC 工作流程 "></li></ol><p>上图取自Core规范文档，其中<code>AuthN=Authentication</code>，表示认证；<code>AuthZ=Authorization</code>，代表授权。注意这里面RP发往OP的请求，是属于<strong>Authentication</strong>类型的请求，虽然在OIDC中是复用OAuth2的<strong>Authorization</strong>请求通道，但是用途是不一样的，且OIDC的AuthN请求中<strong>scope参数必须要有一个值为的openid的参数</strong>(后面会详细介绍AuthN请求所需的参数)，用来区分这是一个OIDC的<strong>Authentication</strong>请求，而不是OAuth2的<strong>Authorization</strong>请求。</p><h2 id=oidc-id-token><i id=locator-oidc-id-token class=header-locator></i>
<a href=#oidc-id-token class=article-h-a>3.3 ID Token</a></h2><p>上面提到过<strong>OIDC对OAuth2最主要的扩展就是提供了ID Token</strong>。ID Token是一个安全令牌，是一个授权服务器提供的包含**用户信息(由一组Cliams构成以及其他辅助的Cliams)**的JWT格式的数据结构。ID Token的主要构成部分如下(使用OAuth2流程的OIDC)。</p><ol><li><code>iss</code> = Issuer Identifier : 必须。提供认证信息者的唯一标识。一般是一个https的url(不包含querystring和fragment部分)。</li><li><code>sub</code> = Subject Identifier : 必须。iss提供的EU的标识，在iss范围内唯一。它会被RP用来标识唯一的用户。最长为255个ASCII个字符。</li><li><code>aud</code> = Audience(s) : 必须。标识ID Token的受众。必须包含OAuth2的client_id。</li><li><code>exp</code> = Expiration time : 必须。过期时间，超过此时间的ID Token会作废不再被验证通过。</li><li><code>iat</code> = Issued At Time : 必须。JWT的构建的时间。</li><li><code>auth_time</code> = AuthenticationTime : EU完成认证的时间。如果RP发送AuthN请求的时候携带max_age的参数，则此Claim是必须的。</li><li><code>nonce</code> : RP发送请求的时候提供的随机字符串，用来减缓重放攻击，也可以来关联ID Token和RP本身的Session信息。</li><li><code>acr</code> = Authentication Context Class Reference : 可选。表示一个认证上下文引用值，可以用来标识认证上下文类。</li><li><code>amr</code> = Authentication Methods References : 可选。表示一组认证方法。</li><li><code>azp</code> = Authorized party : 可选。结合aud使用。只有在被认证的一方和受众(aud)不一致时才使用此值，一般情况下很少使用。</li></ol><p>ID Token通常情况下还会包含其他的Claims(毕竟上述claim中只有sub是和EU相关的，这在一般情况下是不够的，必须还需要EU的用户名，头像等其他的资料，OIDC提供了一组公共的cliams，请移步这里<a href=http://openid.net/specs/openid-connect-core-1_0.html#StandardClaims target=_blank rel="noopener norefferrer">http://openid.net/specs/openid-connect-core-1_0.html#StandardClaims</a>。另外ID Token必须使用JWS进行签名和JWE加密，从而提供认证的完整性、不可否认性以及可选的保密性。一个ID Token中包含的信息的例子如下 :</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  &#34;iss&#34;: <span style=color:#a31515>&#34;https://server.example.com&#34;</span>,
</span></span><span style=display:flex><span>  &#34;sub&#34;: <span style=color:#a31515>&#34;24400320&#34;</span>,
</span></span><span style=display:flex><span>  &#34;aud&#34;: <span style=color:#a31515>&#34;s6BhdRkqt3&#34;</span>,
</span></span><span style=display:flex><span>  &#34;nonce&#34;: <span style=color:#a31515>&#34;n-0S6_WzA2Mj&#34;</span>,
</span></span><span style=display:flex><span>  &#34;exp&#34;: 1311281970,
</span></span><span style=display:flex><span>  &#34;iat&#34;: 1311280970,
</span></span><span style=display:flex><span>  &#34;auth_time&#34;: 1311280969,
</span></span><span style=display:flex><span>  &#34;acr&#34;: <span style=color:#a31515>&#34;urn:mace:incommon:iap:silver&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=authentication><i id=locator-authentication class=header-locator></i>
<a href=#authentication class=article-h-a>3.4 认证</a></h2><p>解释完了ID Token是什么，下面就看一下OIDC如何获取到<code>ID Token</code>，因为OIDC基于OAuth2，所以OIDC的认证流程主要是由OAuth2的几种授权流程延伸而来的，有以下3种 :</p><ol><li>Authorization Code Flow : 使用OAuth2的授权码来换取Id Token和Access Token。</li><li>Implicit Flow : 使用OAuth2的Implicit流程获取Id Token和Access Token。</li><li>Hybrid Flow : 混合Authorization Code Flow+Implici Flow。</li></ol><blockquote><p>这里有个小问题大家可以思考下，OAuth2中还有基于Resource Owner Password Credentials Grant和Client Credentials Grant的方式来获取Access Token，为什么OIDC没有扩展这些方式呢？</p><ol><li><p>Resource Owner Password Credentials Grant是需要用途提供账号密码给RP的，账号密码给到RP了，还要什么自行车(ID Token)。。。</p></li><li><p>Client Credentials Grant这种方式根本就不需要用户参与，更谈不上用户身份认证了。这也能反映授权和认证的差异，以及只使用OAuth2来做身份认证的事情是远远不够的，也是不合适的。</p></li></ol></blockquote><h3 id=based-on-authorization-code-authentication-request><i id=locator-based-on-authorization-code-authentication-request class=header-locator></i>
<a href=#based-on-authorization-code-authentication-request class=article-h-a>3.4.1 基于Authorization Code的认证请求</a></h3><p>这种方式使用OAuth2的Authorization Code的方式来完成用户身份认证，所有的Token都是通过Token EndPoint(OAuth2中定义 : <a href=https://tools.ietf.org/html/rfc6749#section-3.2 target=_blank rel="noopener norefferrer">https://tools.ietf.org/html/rfc6749#section-3.2</a>)来发放的。构建一个OIDC的Authentication Request需要提供如下的参数 :</p><ol><li>scope : 必须。OIDC的请求必须包含值为<code>openid</code>的scope的参数。</li><li>response_type : 必选。同OAuth2。</li><li>client_id : 必选。同OAuth2。</li><li>redirect_uri : 必选。同OAuth2。</li><li>state : 推荐。同OAuth2。防止CSRF, XSRF。</li></ol><p>以上这5个参数是和OAuth2相同的。除此之外，还定义了如下的参数 :</p><ol><li><code>response_mode</code> : 可选。OIDC新定义的参数(<a href=http://openid.net/specs/oauth-v2-form-post-response-mode-1_0.html target=_blank rel="noopener norefferrer">OAuth 2.0 Form Post Response Mode</a>)，用来指定Authorization Endpoint以何种方式返回数据。</li><li><code>nonce</code> : 可选。ID Token中的出现的nonce就是来源于此。</li><li><code>display</code> : 可选。指示授权服务器呈现怎样的界面给EU。有效值有(page，popup，touch，wap)，其中默认是page。page=普通的页面，popup=弹出框，touch=支持触控的页面，wap=移动端页面。</li><li><code>prompt</code> : 可选。这个参数允许传递多个值，使用空格分隔。用来指示授权服务器是否引导EU重新认证和同意授权(consent，就是EU完成身份认证后的确认同意授权的页面)。有效值有(none，login，consent，select_account)。none=不实现现任何认证和确认同意授权的页面，如果没有认证授权过，则返回错误login_required或interaction_required。login=重新引导EU进行身份认证，即使已经登录。consent=重新引导EU确认同意授权。select_account=假如EU在授权服务器有多个账号的话，允许EU选择一个账号进行认证。</li><li><code>max_age</code> : 可选。代表EU认证信息的有效时间，对应ID Token中auth_time的claim。比如设定是20分钟，则超过了时间，则需要引导EU重新认证。</li><li><code>ui_locales</code> : 可选。用户界面的本地化语言设置项。</li><li><code>id_token_hint</code> : 可选。之前发放的ID Token，如果ID Token经过验证且是有效的，则需要返回一个正常的响应；如果有误，则返回对应的错误提示。</li><li><code>login_hint</code> : 可选。向授权服务器提示登录标识符，EU可能会使用它登录(如果需要的话)。比如指定使用用户使用Timetombs账号登录，当然EU也可以使用其他账号登录，这只是类似html中input元素的placeholder。</li><li><code>acr_values</code> : 可选。Authentication Context Class Reference values，对应ID Token中的acr的Claim。此参数允许多个值出现，使用空格分割。</li></ol><p>以上是基于Authorization Code方式的OIDC的认证请求所需的参数。在OIDC的其他认证流程中也会有其他的参数或不同的参数值(稍有差异)。一个简单的示例如下 :</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span>GET /authorize?response_type=code&amp;scope=openid%20profile%20email&amp;client_id=s6BhdRkqt3&amp;state=af0ifjsldkj&amp;redirect_uri=https%3A%2F%2Fclient.example.org%2Fcb <span style=color:#00f>HTTP</span>/1.1
</span></span><span style=display:flex><span>Host: server.example.com
</span></span></code></pre></div><p>也可以是一个基于302的重定向方式。</p><h3 id=based-on-authorization-code-authentication-response><i id=locator-based-on-authorization-code-authentication-response class=header-locator></i>
<a href=#based-on-authorization-code-authentication-response class=article-h-a>3.4.2 基于Authorization Code的认证请求的响应</a></h3><p>在授权服务器接收到认证请求之后，需要对请求参数做严格的验证，具体的规则参见<a href=http://openid.net/specs/openid-connect-core-1_0.html#AuthRequestValidation target=_blank rel="noopener norefferrer">http://openid.net/specs/openid-connect-core-1_0.html#AuthRequestValidation</a>，验证通过后引导EU进行身份认证并且同意授权。在这一切都完成后，会重定向到RP指定的回调地址，并且把code和state参数传递过去。比如 :</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#00f>HTTP</span>/1.1 302 Found
</span></span><span style=display:flex><span>Location: https://client.example.org/cb?code=SplxlOBeZQQYbYS6WxSbIA&amp;state=af0ifjsldkj
</span></span></code></pre></div><h3 id=get-id-token><i id=locator-get-id-token class=header-locator></i>
<a href=#get-id-token class=article-h-a>3.4.3 获取ID Token</a></h3><p>RP使用上一步获得的code来请求Token EndPoint，这一步同OAuth2，就不再展开细说了。然后Token EndPoint会返回响应的Token，其中除了OAuth2规定的部分数据外，还会附加一个<strong>id_token</strong>的字段。id_token字段就是上面提到的ID Token。例如 :</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#00f>HTTP</span>/1.1 200 OK
</span></span><span style=display:flex><span>Content-Type: application/json
</span></span><span style=display:flex><span>Cache-Control: no-store
</span></span><span style=display:flex><span>Pragma: no-cache
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  &#34;access_token&#34;: <span style=color:#a31515>&#34;SlAV32hkKG&#34;</span>,
</span></span><span style=display:flex><span>  &#34;token_type&#34;: <span style=color:#a31515>&#34;Bearer&#34;</span>,
</span></span><span style=display:flex><span>  &#34;refresh_token&#34;: <span style=color:#a31515>&#34;8xLOxBtZp8&#34;</span>,
</span></span><span style=display:flex><span>  &#34;expires_in&#34;: 3600,
</span></span><span style=display:flex><span>  &#34;id_token&#34;: <span style=color:#a31515>&#34;eyJhbGciOiJSUzI1NiIsImtpZCI6IjFlOWdkazcifQ.ewogImlzc
</span></span></span><span style=display:flex><span><span style=color:#a31515>    yI6ICJodHRwOi8vc2VydmVyLmV4YW1wbGUuY29tIiwKICJzdWIiOiAiMjQ4Mjg5
</span></span></span><span style=display:flex><span><span style=color:#a31515>    NzYxMDAxIiwKICJhdWQiOiAiczZCaGRSa3F0MyIsCiAibm9uY2UiOiAibi0wUzZ
</span></span></span><span style=display:flex><span><span style=color:#a31515>    fV3pBMk1qIiwKICJleHAiOiAxMzExMjgxOTcwLAogImlhdCI6IDEzMTEyODA5Nz
</span></span></span><span style=display:flex><span><span style=color:#a31515>    AKfQ.ggW8hZ1EuVLuxNuuIJKX_V8a_OMXzR0EHR9R6jgdqrOOF4daGU96Sr_P6q
</span></span></span><span style=display:flex><span><span style=color:#a31515>    Jp6IcmD3HP99Obi1PRs-cwh3LO-p146waJ8IhehcwL7F09JdijmBqkvPeB2T9CJ
</span></span></span><span style=display:flex><span><span style=color:#a31515>    NqeGpe-gccMg4vfKjkM8FcGvnzZUN4_KSP0aAp1tOJ1zZwgjxqGByKHiOtX7Tpd
</span></span></span><span style=display:flex><span><span style=color:#a31515>    QyHE5lcMiKPXfEIQILVq0pc_E2DzL7emopWoaoZTF_m0_N0YzFC6g6EJbOEoRoS
</span></span></span><span style=display:flex><span><span style=color:#a31515>    K5hoDalrcvRYLSrQAZZKflyuVCyixEoV9GfNQC3_osjzw2PAithfubEEBLuVVk4
</span></span></span><span style=display:flex><span><span style=color:#a31515>    XUVrWOLrLl0nx7RkKU8NXNHq-rvKMzqg&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>其中看起来一堆乱码的部分就是JWT格式的ID Token。在RP拿到这些信息之后，需要对id_token以及access_token进行验证(具体的规则参见<a href=http://openid.net/specs/openid-connect-core-1_0.html#IDTokenValidation target=_blank rel="noopener norefferrer">http://openid.net/specs/openid-connect-core-1_0.html#IDTokenValidation</a>和<a href=http://openid.net/specs/openid-connect-core-1_0.html#ImplicitTokenValidation target=_blank rel="noopener norefferrer">http://openid.net/specs/openid-connect-core-1_0.html#ImplicitTokenValidation</a>)。至此，可以说用户身份认证就可以完成了，后续可以根据UserInfo EndPoint获取更完整的信息。</p><h3 id=implicit-flow-and-hybrid-flow><i id=locator-implicit-flow-and-hybrid-flow class=header-locator></i>
<a href=#implicit-flow-and-hybrid-flow class=article-h-a>3.4.4 Implicit Flow和Hybrid Flow</a></h3><p>Implicit Flow的工作方式是在OAuth2 Implicit Flow上附加提供id_token，当然，认证请求的参数和基于Authorization Code的流程稍有不同，具体的差异参见<a href=http://openid.net/specs/openid-connect-core-1_0.html#ImplicitAuthRequest target=_blank rel="noopener norefferrer">http://openid.net/specs/openid-connect-core-1_0.html#ImplicitAuthRequest</a>，这里就不做详细介绍了。</p><p>Hybrid Flow则=Authorization Code Flow+Implicit Flow，也不再详细介绍了。</p><h2 id=5.userinfo-endpoint><i id=locator-5.userinfo-endpoint class=header-locator></i>
<a href=#5.userinfo-endpoint class=article-h-a>3.5 UserInfo Endpoint</a></h2><p>UserIndo EndPoint是一个受OAuth2保护的资源。在RP得到Access Token后可以请求此资源，然后获得一组EU相关的Claims，这些信息可以说是ID Token的扩展，比如如果你觉得ID Token中只需包含EU的唯一标识sub即可(避免ID Token过于庞大)，然后通过此接口获取完整的EU的信息。此资源必须部署在TLS之上，例如 :</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span>GET /userinfo <span style=color:#00f>HTTP</span>/1.1
</span></span><span style=display:flex><span>Host: server.example.com
</span></span><span style=display:flex><span>Authorization: Bearer SlAV32hkKG
</span></span></code></pre></div><p>成功之后响应如下 :</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#00f>HTTP</span>/1.1 200 OK
</span></span><span style=display:flex><span>Content-Type: application/json
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  &#34;sub&#34;: <span style=color:#a31515>&#34;248289761001&#34;</span>,
</span></span><span style=display:flex><span>  &#34;name&#34;: <span style=color:#a31515>&#34;Jane Doe&#34;</span>,
</span></span><span style=display:flex><span>  &#34;given_name&#34;: <span style=color:#a31515>&#34;Jane&#34;</span>,
</span></span><span style=display:flex><span>  &#34;family_name&#34;: <span style=color:#a31515>&#34;Doe&#34;</span>,
</span></span><span style=display:flex><span>  &#34;preferred_username&#34;: <span style=color:#a31515>&#34;j.doe&#34;</span>,
</span></span><span style=display:flex><span>  &#34;email&#34;: <span style=color:#a31515>&#34;janedoe@example.com&#34;</span>,
</span></span><span style=display:flex><span>  &#34;picture&#34;: <span style=color:#a31515>&#34;http://example.com/janedoe/me.jpg&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>其中<code>sub</code>代表<code>EU</code>的唯一标识，这个claim是必须的，其他的都是可选的。</p><h1 id=summary><i id=locator-summary class=header-locator></i>
<a href=#summary class=article-h-a>4 总结</a></h1><p>继OAuth2之后，感觉OIDC也要大放异彩了。其本身是一个完全开放的标准，而且兼容众多的已有的IDP(身份提供商)，比如基于SAML的、基于WS-Federation的等等已有的身份认证系统，都可以作为OIDC的OP存在。总结一下OIDC有那些特性和好处吧 :</p><ol><li>OIDC使得身份认证可以作为一个服务存在。</li><li>OIDC可以很方便的实现SSO(跨顶级域)。</li><li>OIDC兼容OAuth2，可以使用Access Token控制受保护的API资源。</li><li>OIDC可以兼容众多的IDP作为OIDC的OP来使用。</li><li>OIDC的一些敏感接口均强制要求TLS，除此之外，得益于JWT,JWS,JWE家族的安全机制，使得一些敏感信息可以进行数字签名、加密和验证，进一步确保整个认证过程中的安全保障。</li></ol><p>以上内容均是个人的一些理解，如果错误之处，欢迎指正！</p><h1 id=example><i id=locator-example class=header-locator></i>
<a href=#example class=article-h-a>5 示例</a></h1><p>笔者基于IdentityServer3和IdentitySever4(两者都是基于OIDC的一个.NET版本的开源实现)写的一个集成SSO,API访问授权控制,GitHub(作为OP)登录,QQ(作为OP)登录的示例 : <a href=https://github.com/linianhui/oidc.example target=_blank rel="noopener norefferrer">https://github.com/linianhui/oidc.example</a>。</p><h1 id=6-参考><i id=locator-6-参考 class=header-locator></i>
<a href=#6-%e5%8f%82%e8%80%83 class=article-h-a>6 参考</a></h1><p>官方资料 :</p><p><a href=http://openid.net/connect/ target=_blank rel="noopener norefferrer">http://openid.net/connect/</a></p><p><a href=http://openid.net/connect/faq/ target=_blank rel="noopener norefferrer">http://openid.net/connect/faq/</a></p><p><a href=http://openid.net/developers/certified/ target=_blank rel="noopener norefferrer">http://openid.net/developers/certified/</a></p><p>JWT : <a href=https://tools.ietf.org/html/rfc7519 target=_blank rel="noopener norefferrer">https://tools.ietf.org/html/rfc7519</a></p><p>JWS : <a href=https://tools.ietf.org/html/rfc7515 target=_blank rel="noopener norefferrer">https://tools.ietf.org/html/rfc7515</a></p><p>JWE : <a href=https://tools.ietf.org/html/rfc7516 target=_blank rel="noopener norefferrer">https://tools.ietf.org/html/rfc7516</a></p><p>.NET的开源实现 : <a href=https://github.com/IdentityServer target=_blank rel="noopener norefferrer">https://github.com/IdentityServer</a></p><p>视频 : <a href="https://www.youtube.com/watch?v=Kb56GzQ2pSk" target=_blank rel="noopener norefferrer">Identity, Authentication + OAuth = OpenID Connect</a></p><p>案例 :</p><p><a href=https://docs.microsoft.com/en-us/azure/active-directory/develop/active-directory-protocols-openid-connect-code target=_blank rel="noopener norefferrer">https://docs.microsoft.com/en-us/azure/active-directory/develop/active-directory-protocols-openid-connect-code</a></p><p><a href=https://developers.google.com/identity/protocols/OpenIDConnect target=_blank rel="noopener norefferrer">https://developers.google.com/identity/protocols/OpenIDConnect</a></p></section><section class=article-meta><section class=article-date>2017-05-30 09:18，约6762字，阅读约14分钟</section><section class=article-topics><a class=article-topic href=/authentication-and-authorization/ title=[认证&授权] target=_blank><i class="fa fa-folder"></i>[认证&授权]</a></section><section class=article-tags><a class=article-tag href=/tag/id-token target=_blank><i class="fa fa-tag"></i>Id Token</a>
<a class=article-tag href=/tag/jwt target=_blank><i class="fa fa-tag"></i>JWT</a>
<a class=article-tag href=/tag/oauth2 target=_blank><i class="fa fa-tag"></i>OAuth2</a>
<a class=article-tag href=/tag/oidc target=_blank><i class="fa fa-tag"></i>OIDC</a>
<a class=article-tag href=/tag/op target=_blank><i class="fa fa-tag"></i>OP</a>
<a class=article-tag href=/tag/openid-connect target=_blank><i class="fa fa-tag"></i>OpenId Connect</a>
<a class=article-tag href=/tag/rp target=_blank><i class="fa fa-tag"></i>RP</a></section><section class=article-git><a class=article-git-commit href=https://github.com/linianhui/blog/commit/03e0cc08866458647d96951c1817c624518149d6 target=_blank><i class="fa fa-code-fork"></i>03e0cc0</a>
<span class=article-git-commit-subject>fix add displayed_on_home</span>
<span class=article-git-commit-time>2022-11-20 14:49</span>
<a class=article-git-source href=https://github.com/linianhui/blog/blob/main/src/authentication-and-authorization/04-openid-connect-core/index.md target=_blank><i class="fa fa-github"></i>源码</a></section></section><section class=article-page><div class=article-page-prev><span>上一篇 : </span><a href=/authentication-and-authorization/06-permission-based-access-control/ target=_blank>[认证&授权] 06 Permission Based Access Control</a></div></section></article><section id=article-comment class=article-comment><script src=https://utteranc.es/client.js repo=linianhui/blog issue-term=pathname label=blog-comment theme=github-light crossorigin=anonymous async></script></section></main><footer class=footer><section>Copyright © 2025 by <a href=https://github.com/linianhui/blog target=_blank>Timetombs</a></section><section><a class=article-git-commit href=https://github.com/linianhui/blog/commit/2fac07e818d6d4ad6b78781efea82c28769c8c02 target=_blank><i class="fa fa-code-fork"></i>2fac07e</a>
Powered by
<a href=https://github.com/actions target=_blank>GitHub Actions</a>
,
<a href=https://github.com/gohugoio/hugo target=_blank>Hugo</a>
and
<a href=https://github.com/utterance/utterances target=_blank>utterances</a>
Hosted on <a href=https://pages.github.com/ target=_blank>GitHub Pages</a><section></footer></main><aside class=toolbar><a class="fa fa-list" href=javascript:blog.toggleToc(); title=目录></a><a class="fa fa-comments" href=#article-comment title=评论></a><a class="fa fa-arrow-up" href=javascript:scroll(0,0); title=返回顶部></a></aside><script type=text/javascript>var _hmt=_hmt||[];blog.addOnScorllEvent()</script><script src=https://hm.baidu.com/hm.js?b2cc3cea316e1f7a8def1bab8dc98fad async></script></body></html>