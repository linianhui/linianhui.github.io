<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=google-site-verification content="X6gTMGCy1-_vb5i3aja3ZZyzPY3raiKRJp4VIhOAX24"><meta name=msvalidate.01 content="CDE7502649B75529BD0FCFE89B056E38"><title>[Java] JMM(Java Memory Model) - Timetombs</title>
<link rel=icon type=image/svg href=/favicon.svg><link rel=stylesheet href=https://s4.zstatic.net/ajax/libs/normalize/8.0.1/normalize.min.css crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://s4.zstatic.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css crossorigin=anonymous referrerpolicy=no-referrer><link href='/asset/blog.css?time=2025-10-26T19%3a03%3a29Z%2b08%3a00' rel=stylesheet type=text/css><script src=https://s4.zstatic.net/npm/currency.js@2.0.4/dist/currency.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://s4.zstatic.net/ajax/libs/moment.js/2.30.1/moment.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src='/asset/blog.js?time=2025-10-26T19%3a03%3a29Z%2b08%3a00' type=application/javascript></script><script type=text/javascript>blog.isMobile()&&document.write('<link href="/asset/blog.mobile.css?time=2025-10-26T19%3A03%3A29Z%2B08%3A00" rel="stylesheet">')</script></head><body><div id=horizontal-progress class=horizontal-progress></div><aside id=toc class=toc><section class=toc-header><a class=toc-page-title href=/java/ target=_blank>[Java]</a></section><section class=toc-page><a class=toc-page-title href=/java/install/ target=_blank>[Java] Install</a></section><section class=toc-page><a class=toc-page-title href=/java/jvm/ target=_blank>[Java] JVM(Java Virtual Machine)</a></section><section class=toc-page><a class=toc-page-title href=/java/tool/ target=_blank>[Java] Tool</a></section><section class=toc-page><a class=toc-page-title href=/java/unsafe/ target=_blank>[Java] Unsafe类</a></section><section class="toc-page selected"><span class=toc-page-title>[Java] JMM(Java Memory Model)</span><nav id=TableOfContents><ul><li><a href=#happens-before>1 指令重排和happens-before</a></li><li><a href=#volatile>2 volatile 关键字</a></li><li><a href=#参考资料>参考资料</a></li></ul></nav></section><section class=toc-page><a class=toc-page-title href=/java/gc/ target=_blank>[Java] GC(Garbage Collection)</a></section><section class=toc-page><a class=toc-page-title href=/java/thread/ target=_blank>[Java] Thread</a></section><section class=toc-page><a class=toc-page-title href=/java/cas/ target=_blank>[Java] CAS(Compare And Swap)</a></section><section class=toc-page><a class=toc-page-title href=/java/synchronized/ target=_blank>[Java] synchronized</a></section><script type=text/javascript>blog.isPC()&&blog.toggleToc()</script></aside><main class=main><header class=header><hgroup class=header-hgroup><h1 class=header-hgroup-title><a href=/>Timetombs</a></h1><h2 class=header-hgroup-subtitle>泛义的工具是文明的基础，而确指的工具却是愚人的器物</h2></hgroup><nav class=header-nav><a class=header-nav-item href=/topic/ title=专题 target=_self><i class="fa fa-folder"></i>专题</a>
<a class=header-nav-item href=/tag/ title=标签 target=_self><i class="fa fa-tags"></i>标签</a>
<a class=header-nav-item href=/archive/ title=归档 target=_self><i class="fa fa-archive"></i>归档</a>
<a class=header-nav-item href=https://linianhui.cnblogs.com title=博客园 target=_black><img src=/asset/cnblogs.favicon.svg>博客园</a>
<a class=header-nav-item href=https://github.com/linianhui/blog title=GitHub target=_black><i class="fa fa-github"></i>GitHub</a></nav><div class=header-stats><div class=stats><span>共
<i>66<sub>h</sub>
</i>/
<i>118<sub>a</sub>
</i>篇</span><div class=stats-date>，更新于 2025-10-26T19:03:29Z+08:00 by &nbsp;
<a class=git-commit href=https://github.com/linianhui/blog/commit/2fac07e818d6d4ad6b78781efea82c28769c8c02 target=_blank><i class="fa fa-code-fork"></i>2fac07e</a></div></div><form class=search method=GET target=_blank action=https://www.bing.com/search><input name=q class=search-input type=search placeholder=search... results=5 onkeypress="search_param.value=search_param_site.value+this.value">
<input id=search_param_site type=hidden value="site:linianhui.github.io ">
<input name=q id=search_param type=hidden></form></div></header><main class=content><article class=article><h1 class=article-title>[Java] JMM(Java Memory Model)</h1><div class=article-copyright><span>版权声明 - </span><a href=/copyright/cc target=_blank>CC BY-NC-SA 4.0</a></div><section class=article-meta><section class=article-date>2020-11-05 19:32，约1573字，阅读约4分钟</section><section class=article-topics><a class=article-topic href=/java/ title=[Java] target=_blank><i class="fa fa-folder"></i>[Java]</a></section><section class=article-tags><a class=article-tag href=/tag/java target=_blank><i class="fa fa-tag"></i>Java</a>
<a class=article-tag href=/tag/jmm target=_blank><i class="fa fa-tag"></i>JMM</a></section><section class=article-git><a class=article-git-commit href=https://github.com/linianhui/blog/commit/03e0cc08866458647d96951c1817c624518149d6 target=_blank><i class="fa fa-code-fork"></i>03e0cc0</a>
<span class=article-git-commit-subject>fix add displayed_on_home</span>
<span class=article-git-commit-time>2022-11-20 14:49</span>
<a class=article-git-source href=https://github.com/linianhui/blog/blob/main/src/java/jmm/index.md target=_blank><i class="fa fa-github"></i>源码</a></section></section><section class=article-content><p>Java内存模型JMM(Java Memory Model)在Java中由两份规范文档定义:</p><ol><li>JLS(Java Language Specification)的Chapter 17. Threads and Locks]<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>。</li><li>JSR-133: Java Memory Model and Thread Specification Revision<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>。JSR-133(JDK 5实现了)是对JLS中的补充和完善。</li></ol><blockquote><p>A memory model describes, given a program and an execution trace of that program, whether the execution trace is a legal execution of the program. The Java programming language memory model works by examining each read in an execution trace and checking that the write observed by that read is valid according to certain rules.</p></blockquote><p>以上部分是JLS中关于JMM的总结性解释。简单来说就是<strong>规定了Java中的各种变量的读写访问规则</strong>。</p><blockquote><p>这里的变量指的是实例字段，静态字段等；并不包含局部变量<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>或者方法的参数。因为后者是线程私有的，不会被共享，也就无需定义访问规则，串行的访问就可以了。</p></blockquote><p>JMM规定了：</p><ol><li>所有变量都存储在主内存中。</li><li>每个线程有自己的工作内存（保存了使用的变量的主内存的副本），所有操作都必须在工作内存中进行。</li><li>那么不同的线程之间如果需要共享变量的值，就都需要通过主内存来完成。</li></ol><img src=jmm.png loading=lazy decoding=auto alt=JMM的工作流程 title=JMM的工作流程><p>需要值得注意的地方是这里的主内存和工作内存于Java的内存区域中的堆、栈、元数据区等并无任何关系，属于不同层次的视角。如果一定要对应起来的化，那么根据变量、主内存和工作内存的定义来看：</p><ol><li>主内存对应的是堆中的Java的对象的实例数据。物理中的内存。</li><li>工作内存对应着Java线程栈中的局部变量表等部分区域的数据。为了提升速度，工作内存可能存储在CPU的高速缓存中或者寄存器中。</li></ol><h1 id=happens-before><i id=locator-happens-before class=header-locator></i>
<a href=#happens-before class=article-h-a>1 指令重排和happens-before</a></h1><p>为了提供性能，编译器和CPU通常会对指令进行重排：</p><ol><li>编译器级别的重排。不改变单线程代码语义的情况下，优化指令的顺序。</li><li>指令并行的重排。把原本是串行的指令调整为并行执行，不改变依赖性。</li><li>内存系统的重排。cpu缓存。</li></ol><p>JMM提供的是语言级别的内存模型，所以可以确保在不同的编译器和CPU平台上，通过禁止一些重排，来提供一致的内存可见性。<br>编译器禁止重排是通过添加一些内存屏障指令，来标记不能重排。</p><p>JDK 1.5时引入了happens-before的规则，通过它来描述操作的可见性。比如</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#2b91af>int</span> i=1;    <span style=color:green>// A</span>
</span></span><span style=display:flex><span><span style=color:#2b91af>int</span> j=i+1;  <span style=color:green>// B</span>
</span></span></code></pre></div><p>上面就是A happens-before B。JMM可以保证B在执行时，A的结果对B是可见的。</p><ol><li>程序顺序：一个线程中，每个操作都before于后续的操作。</li><li>监视器锁：每一个监视器的解锁，before于后面的加锁。</li><li>volatile关键字: 对一个volatile的写，before后续任意的读。</li><li>传递性: A before B, B before C，那么A before C。</li></ol><h1 id=volatile><i id=locator-volatile class=header-locator></i>
<a href=#volatile class=article-h-a>2 volatile 关键字</a></h1><p>两个特征：</p><ol><li>保证被修饰的变量对所有线程的可见性。</li><li>禁止指令重排优化。</li></ol><p>实现原理：</p><ol><li>写操作强制同步到主内存。</li><li>写操作强制失效其他线程的工作内存中的变量值。</li></ol><p>四种类型的内存屏障（lock前缀的指令，把缓存同步到主内存，同时使得处理器的其他核心的缓存无效，这样读取的时候就会从主内存重写加载）：</p><ol><li>LoadLoad : Load1—>LoadLoad—>Load2 Load1的结果对Load2可见。</li><li>StoreStore : Store1—>StoreStore—>Store2 Store1的结果对其他处理器可见</li><li>LoadStore : Load1—>LoadStore—>Store2 Load1的结果对后续的操作可见</li><li>StoreLoad : Store1—>StoreLoad—>Load2 Store1的结果对其他处理器可见。</li></ol><h1 id=参考资料><i id=locator-参考资料 class=header-locator></i>
<a href=#%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99 class=article-h-a>参考资料</a></h1><p>深入理解Java内存模型 : <a href=https://www.infoq.cn/minibook/java_memory_model target=_blank rel="noopener norefferrer">https://www.infoq.cn/minibook/java_memory_model</a></p><p>深入浅出Java多线程 : <a href=http://concurrent.redspider.group/RedSpider.html target=_blank rel="noopener norefferrer">http://concurrent.redspider.group/RedSpider.html</a></p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Java Language Specification ：<a href=https://docs.oracle.com/javase/specs/jls/se8/html/jls-17.html#jls-17.4 target=_blank rel="noopener norefferrer">https://docs.oracle.com/javase/specs/jls/se8/html/jls-17.html#jls-17.4</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>JSR-133：Java Memory Model and Thread Specification Revision <a href="https://www.jcp.org/en/jsr/detail?id=133" target=_blank rel="noopener norefferrer">https://www.jcp.org/en/jsr/detail?id=133</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>如果局部变量是一个reference引用类型，那么它引用的对象在Java堆中可以被各个线程共享，但是reference本身在Java栈的局部变量表中是线程私有的。&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></section><section class=article-meta><section class=article-date>2020-11-05 19:32，约1573字，阅读约4分钟</section><section class=article-topics><a class=article-topic href=/java/ title=[Java] target=_blank><i class="fa fa-folder"></i>[Java]</a></section><section class=article-tags><a class=article-tag href=/tag/java target=_blank><i class="fa fa-tag"></i>Java</a>
<a class=article-tag href=/tag/jmm target=_blank><i class="fa fa-tag"></i>JMM</a></section><section class=article-git><a class=article-git-commit href=https://github.com/linianhui/blog/commit/03e0cc08866458647d96951c1817c624518149d6 target=_blank><i class="fa fa-code-fork"></i>03e0cc0</a>
<span class=article-git-commit-subject>fix add displayed_on_home</span>
<span class=article-git-commit-time>2022-11-20 14:49</span>
<a class=article-git-source href=https://github.com/linianhui/blog/blob/main/src/java/jmm/index.md target=_blank><i class="fa fa-github"></i>源码</a></section></section><section class=article-page><div class=article-page-prev><span>上一篇 : </span><a href=/java/unsafe/ target=_blank>[Java] Unsafe类</a></div><div class=article-page-next><span>下一篇 : </span><a href=/java/gc/ target=_blank>[Java] GC(Garbage Collection)</a></div></section></article><section id=article-comment class=article-comment><script src=https://utteranc.es/client.js repo=linianhui/blog issue-term=pathname label=blog-comment theme=github-light crossorigin=anonymous async></script></section></main><footer class=footer><section>Copyright © 2025 by <a href=https://github.com/linianhui/blog target=_blank>Timetombs</a></section><section><a class=article-git-commit href=https://github.com/linianhui/blog/commit/2fac07e818d6d4ad6b78781efea82c28769c8c02 target=_blank><i class="fa fa-code-fork"></i>2fac07e</a>
Powered by
<a href=https://github.com/actions target=_blank>GitHub Actions</a>
,
<a href=https://github.com/gohugoio/hugo target=_blank>Hugo</a>
and
<a href=https://github.com/utterance/utterances target=_blank>utterances</a>
Hosted on <a href=https://pages.github.com/ target=_blank>GitHub Pages</a><section></footer></main><aside class=toolbar><a class="fa fa-list" href=javascript:blog.toggleToc(); title=目录></a><a class="fa fa-comments" href=#article-comment title=评论></a><a class="fa fa-arrow-up" href=javascript:scroll(0,0); title=返回顶部></a></aside><script type=text/javascript>var _hmt=_hmt||[];blog.addOnScorllEvent()</script><script src=https://hm.baidu.com/hm.js?b2cc3cea316e1f7a8def1bab8dc98fad async></script></body></html>