<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=google-site-verification content="X6gTMGCy1-_vb5i3aja3ZZyzPY3raiKRJp4VIhOAX24"><meta name=msvalidate.01 content="CDE7502649B75529BD0FCFE89B056E38"><title>[Java] CAS(Compare And Swap) - Timetombs</title>
<link rel=icon type=image/svg href=/favicon.svg><link rel=stylesheet href=https://s4.zstatic.net/ajax/libs/normalize/8.0.1/normalize.min.css crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://s4.zstatic.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css crossorigin=anonymous referrerpolicy=no-referrer><link href='/asset/blog.css?time=2025-10-26T19%3a03%3a29Z%2b08%3a00' rel=stylesheet type=text/css><script src=https://s4.zstatic.net/npm/currency.js@2.0.4/dist/currency.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://s4.zstatic.net/ajax/libs/moment.js/2.30.1/moment.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src='/asset/blog.js?time=2025-10-26T19%3a03%3a29Z%2b08%3a00' type=application/javascript></script><script type=text/javascript>blog.isMobile()&&document.write('<link href="/asset/blog.mobile.css?time=2025-10-26T19%3A03%3A29Z%2B08%3A00" rel="stylesheet">')</script></head><body><div id=horizontal-progress class=horizontal-progress></div><aside id=toc class=toc><section class=toc-header><a class=toc-page-title href=/java/ target=_blank>[Java]</a></section><section class=toc-page><a class=toc-page-title href=/java/install/ target=_blank>[Java] Install</a></section><section class=toc-page><a class=toc-page-title href=/java/jvm/ target=_blank>[Java] JVM(Java Virtual Machine)</a></section><section class=toc-page><a class=toc-page-title href=/java/tool/ target=_blank>[Java] Tool</a></section><section class=toc-page><a class=toc-page-title href=/java/unsafe/ target=_blank>[Java] Unsafe类</a></section><section class=toc-page><a class=toc-page-title href=/java/jmm/ target=_blank>[Java] JMM(Java Memory Model)</a></section><section class=toc-page><a class=toc-page-title href=/java/gc/ target=_blank>[Java] GC(Garbage Collection)</a></section><section class=toc-page><a class=toc-page-title href=/java/thread/ target=_blank>[Java] Thread</a></section><section class="toc-page selected"><span class=toc-page-title>[Java] CAS(Compare And Swap)</span><nav id=TableOfContents><ul><li><a href=#1-cascompare-and-swap-概念和原理>1 CAS(Compare And Swap) 概念和原理</a></li><li><a href=#2-java中的cas>2 Java中的CAS</a></li><li><a href=#3-java中依赖unsafe的cas实现的一些原子操作类>3 Java中依赖Unsafe的CAS实现的一些原子操作类</a></li><li><a href=#4-cas的三大问题>4 CAS的三大问题</a><ul><li><a href=#41-aba问题>4.1 ABA问题</a></li><li><a href=#42-循环导致cpu消耗过多>4.2 循环导致CPU消耗过多</a></li><li><a href=#43-只能保证一个共享变量的原子操作>4.3 只能保证一个共享变量的原子操作</a></li></ul></li><li><a href=#5-参考资料>5 参考资料</a></li></ul></nav></section><section class=toc-page><a class=toc-page-title href=/java/synchronized/ target=_blank>[Java] synchronized</a></section><script type=text/javascript>blog.isPC()&&blog.toggleToc()</script></aside><main class=main><header class=header><hgroup class=header-hgroup><h1 class=header-hgroup-title><a href=/>Timetombs</a></h1><h2 class=header-hgroup-subtitle>泛义的工具是文明的基础，而确指的工具却是愚人的器物</h2></hgroup><nav class=header-nav><a class=header-nav-item href=/topic/ title=专题 target=_self><i class="fa fa-folder"></i>专题</a>
<a class=header-nav-item href=/tag/ title=标签 target=_self><i class="fa fa-tags"></i>标签</a>
<a class=header-nav-item href=/archive/ title=归档 target=_self><i class="fa fa-archive"></i>归档</a>
<a class=header-nav-item href=https://linianhui.cnblogs.com title=博客园 target=_black><img src=/asset/cnblogs.favicon.svg>博客园</a>
<a class=header-nav-item href=https://github.com/linianhui/blog title=GitHub target=_black><i class="fa fa-github"></i>GitHub</a></nav><div class=header-stats><div class=stats><span>共
<i>66<sub>h</sub>
</i>/
<i>118<sub>a</sub>
</i>篇</span><div class=stats-date>，更新于 2025-10-26T19:03:29Z+08:00 by &nbsp;
<a class=git-commit href=https://github.com/linianhui/blog/commit/2fac07e818d6d4ad6b78781efea82c28769c8c02 target=_blank><i class="fa fa-code-fork"></i>2fac07e</a></div></div><form class=search method=GET target=_blank action=https://www.bing.com/search><input name=q class=search-input type=search placeholder=search... results=5 onkeypress="search_param.value=search_param_site.value+this.value">
<input id=search_param_site type=hidden value="site:linianhui.github.io ">
<input name=q id=search_param type=hidden></form></div></header><main class=content><article class=article><h1 class=article-title>[Java] CAS(Compare And Swap)</h1><div class=article-copyright><span>版权声明 - </span><a href=/copyright/cc target=_blank>CC BY-NC-SA 4.0</a></div><section class=article-meta><section class=article-date>2020-11-08 19:32，约1405字，阅读约3分钟</section><section class=article-topics><a class=article-topic href=/java/ title=[Java] target=_blank><i class="fa fa-folder"></i>[Java]</a></section><section class=article-tags><a class=article-tag href=/tag/cas target=_blank><i class="fa fa-tag"></i>CAS</a>
<a class=article-tag href=/tag/java target=_blank><i class="fa fa-tag"></i>Java</a></section><section class=article-git><a class=article-git-commit href=https://github.com/linianhui/blog/commit/03e0cc08866458647d96951c1817c624518149d6 target=_blank><i class="fa fa-code-fork"></i>03e0cc0</a>
<span class=article-git-commit-subject>fix add displayed_on_home</span>
<span class=article-git-commit-time>2022-11-20 14:49</span>
<a class=article-git-source href=https://github.com/linianhui/blog/blob/main/src/java/cas/index.md target=_blank><i class="fa fa-github"></i>源码</a></section></section><section class=article-content><h1 id=1-cascompare-and-swap-概念和原理><i id=locator-1-cascompare-and-swap-概念和原理 class=header-locator></i>
<a href=#1-cascompare-and-swap-%e6%a6%82%e5%bf%b5%e5%92%8c%e5%8e%9f%e7%90%86 class=article-h-a>1 CAS(Compare And Swap) 概念和原理</a></h1><p>CAS是Compare And Swap的缩写，中文含义是比较和交换。CAS定义了三个值：</p><ul><li>V : 待更新的变量Var</li><li>E : 预期的旧值Expected Value</li><li>N : 新值New</li></ul><p>执行过程的伪代码如下：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#00f>if</span>(V==E){
</span></span><span style=display:flex><span>  V=N;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>也就是说只有在变量V的值等于期望的旧值时，才更新V为新值N。不然什么都不做。以此证明其他线程没有更改V的值。<strong>根据上面的伪代码来看，是不是会出现if通过了，但是在V=N的时候其他线程改了V呢？其实不会的，CAS的底层实现是依赖CPU的原子指令(cmpxchgl和lock)来实现的，也就是说比较和赋值操作是一个CPU级别的原子操作！ 那么在多线程操作同一个变量时，只会有一个线程操作成功，其他的都会失败 ，但是并不会阻塞其他线程，其他线程可以利用循环进行重试或者放弃修改。这是实现乐观锁的基础。</strong></p><h1 id=2-java中的cas><i id=locator-2-java中的cas class=header-locator></i>
<a href=#2-java%e4%b8%ad%e7%9a%84cas class=article-h-a>2 Java中的CAS</a></h1><p>Java中提供了Unsafe类来提供CAS操作，目前有如下三个方法。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#00f>public</span> <span style=color:#00f>final</span> <span style=color:#00f>native</span> <span style=color:#2b91af>boolean</span> compareAndSwapObject(Object o, <span style=color:#2b91af>long</span> offset,Object expected, Object x);
</span></span><span style=display:flex><span><span style=color:#00f>public</span> <span style=color:#00f>final</span> <span style=color:#00f>native</span> <span style=color:#2b91af>boolean</span> compareAndSwapInt(Object o, <span style=color:#2b91af>long</span> offset,<span style=color:#2b91af>int</span> expected,<span style=color:#2b91af>int</span> x);
</span></span><span style=display:flex><span><span style=color:#00f>public</span> <span style=color:#00f>final</span> <span style=color:#00f>native</span> <span style=color:#2b91af>boolean</span> compareAndSwapLong(Object o, <span style=color:#2b91af>long</span> offset,<span style=color:#2b91af>long</span> expected,<span style=color:#2b91af>long</span> x);
</span></span></code></pre></div><p>参数和返回值解释：</p><ol><li>参数<code>o</code> : 字段变量所属的对象。</li><li>参数<code>offset</code> : 变量相对于<code>o</code>在内存中的偏移位置。这个值是和class相关的，和具体对象无关。</li><li>参数<code>expected</code> : 期望的旧值。</li><li>参数<code>x</code> : 新值。当前面两个参数定位到的变量的值等于<code>expected</code>代表的旧值是，才更新。</li><li>返回值<code>boolean</code> : 更新成功返回<code>true</code>, 否则就是<code>false</code>。</li></ol><p>这三个方法不会阻塞线程，然后调用方可以根据返回值决定是否重试或者放弃修改。</p><h1 id=3-java中依赖unsafe的cas实现的一些原子操作类><i id=locator-3-java中依赖unsafe的cas实现的一些原子操作类 class=header-locator></i>
<a href=#3-java%e4%b8%ad%e4%be%9d%e8%b5%96unsafe%e7%9a%84cas%e5%ae%9e%e7%8e%b0%e7%9a%84%e4%b8%80%e4%ba%9b%e5%8e%9f%e5%ad%90%e6%93%8d%e4%bd%9c%e7%b1%bb class=article-h-a>3 Java中依赖Unsafe的CAS实现的一些原子操作类</a></h1><p>一个示例<a href=CASExample.java target=_blank rel="noopener norefferrer">CASExample.java</a>。</p><p>Java中依赖Unsafe的CAS实现的一些原子操作类位于<a href=https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/atomic/package-summary.html target=_blank rel="noopener norefferrer">java.util.concurrent.atomic</a>包下。</p><img src=atomic-package.png loading=lazy decoding=auto alt=java.util.concurrent.atomic title=java.util.concurrent.atomic><h1 id=4-cas的三大问题><i id=locator-4-cas的三大问题 class=header-locator></i>
<a href=#4-cas%e7%9a%84%e4%b8%89%e5%a4%a7%e9%97%ae%e9%a2%98 class=article-h-a>4 CAS的三大问题</a></h1><h2 id=41-aba问题><i id=locator-41-aba问题 class=header-locator></i>
<a href=#41-aba%e9%97%ae%e9%a2%98 class=article-h-a>4.1 ABA问题</a></h2><p>ABA指的是V的值原来是A，变成了B，后来又更新为了A。这时JDK1.5引入了一个<a href=https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/atomic/AtomicStampedReference.html target=_blank rel="noopener norefferrer">AtomicStampedReference</a><br>来解决ABA的问题。原理是增加一个<code>Pair&lt;T></code>类型来持有引用和一个附加的标记<code>stamp</code>充当版本号。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#00f>private</span> <span style=color:#00f>static</span> <span style=color:#00f>class</span> <span style=color:#2b91af>Pair</span>&lt;T&gt; {
</span></span><span style=display:flex><span>    <span style=color:#00f>final</span> T reference;
</span></span><span style=display:flex><span>    <span style=color:#00f>final</span> <span style=color:#2b91af>int</span> stamp;
</span></span><span style=display:flex><span>    <span style=color:#00f>private</span> Pair(T reference, <span style=color:#2b91af>int</span> stamp) {
</span></span><span style=display:flex><span>        <span style=color:#00f>this</span>.reference = reference;
</span></span><span style=display:flex><span>        <span style=color:#00f>this</span>.stamp = stamp;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#00f>static</span> &lt;T&gt; Pair&lt;T&gt; of(T reference, <span style=color:#2b91af>int</span> stamp) {
</span></span><span style=display:flex><span>        <span style=color:#00f>return</span> <span style=color:#00f>new</span> Pair&lt;T&gt;(reference, stamp);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在执行cas时，<strong>同时检查这两个字段: 调用时newStamp为expectedStamp+1作为版本号,由于是每次都+1，所以每次更改Pair的reference都会增加stamp，就可以避免ABA的问题了</strong>。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#00f>public</span> <span style=color:#2b91af>boolean</span> compareAndSet(V   expectedReference,
</span></span><span style=display:flex><span>                              V   newReference,
</span></span><span style=display:flex><span>                              <span style=color:#2b91af>int</span> expectedStamp,
</span></span><span style=display:flex><span>                              <span style=color:#2b91af>int</span> newStamp) {
</span></span><span style=display:flex><span>    Pair&lt;V&gt; current = pair;
</span></span><span style=display:flex><span>    <span style=color:#00f>return</span>
</span></span><span style=display:flex><span>        expectedReference == current.reference &amp;&amp;
</span></span><span style=display:flex><span>        expectedStamp == current.stamp &amp;&amp;
</span></span><span style=display:flex><span>        ((newReference == current.reference &amp;&amp;
</span></span><span style=display:flex><span>          newStamp == current.stamp) ||
</span></span><span style=display:flex><span>          casPair(current, Pair.of(newReference, newStamp)));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>当然有时候我们并不关心是不是ABA，而是关心V是否被改动了，即使是先变成了B后又变成了A，也是可以的。所以这时候可以使用<a href=https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/atomic/AtomicMarkableReference.html target=_blank rel="noopener norefferrer">AtomicMarkableReference<t></a>。它和AtomicStampedReference的差异在于Pair的字段不是int，而是boolean了，修改了就是true。</p><h2 id=42-循环导致cpu消耗过多><i id=locator-42-循环导致cpu消耗过多 class=header-locator></i>
<a href=#42-%e5%be%aa%e7%8e%af%e5%af%bc%e8%87%b4cpu%e6%b6%88%e8%80%97%e8%bf%87%e5%a4%9a class=article-h-a>4.2 循环导致CPU消耗过多</a></h2><p>自旋锁通常采用CAS，如果自旋时间过长仍然不成功，会占用大量的CPU资源。</p><p>解决办法时让JVM支持处理器提供的<code>pause</code>指令 : 失败时睡眠一会接着重试。</p><h2 id=43-只能保证一个共享变量的原子操作><i id=locator-43-只能保证一个共享变量的原子操作 class=header-locator></i>
<a href=#43-%e5%8f%aa%e8%83%bd%e4%bf%9d%e8%af%81%e4%b8%80%e4%b8%aa%e5%85%b1%e4%ba%ab%e5%8f%98%e9%87%8f%e7%9a%84%e5%8e%9f%e5%ad%90%e6%93%8d%e4%bd%9c class=article-h-a>4.3 只能保证一个共享变量的原子操作</a></h2><p>两种解决方案：</p><ol><li>使用JDK 1.5提供的<code>AtomicReference</code>类保证对象之间的原子性，把多个变量放到一个对象里面进行CAS操作；</li><li>使用锁。锁内的临界区代码可以保证只有当前线程能操作。</li></ol><h1 id=5-参考资料><i id=locator-5-参考资料 class=header-locator></i>
<a href=#5-%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99 class=article-h-a>5 参考资料</a></h1><ol><li>深入浅出Java多线程-CAS与原子操作: <a href=http://concurrent.redspider.group/article/02/10.html target=_blank rel="noopener norefferrer">http://concurrent.redspider.group/article/02/10.html</a></li><li>java.util.concurrent.atomic : <a href=https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/atomic/package-summary.html target=_blank rel="noopener norefferrer">https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/atomic/package-summary.html</a></li></ol></section><section class=article-meta><section class=article-date>2020-11-08 19:32，约1405字，阅读约3分钟</section><section class=article-topics><a class=article-topic href=/java/ title=[Java] target=_blank><i class="fa fa-folder"></i>[Java]</a></section><section class=article-tags><a class=article-tag href=/tag/cas target=_blank><i class="fa fa-tag"></i>CAS</a>
<a class=article-tag href=/tag/java target=_blank><i class="fa fa-tag"></i>Java</a></section><section class=article-git><a class=article-git-commit href=https://github.com/linianhui/blog/commit/03e0cc08866458647d96951c1817c624518149d6 target=_blank><i class="fa fa-code-fork"></i>03e0cc0</a>
<span class=article-git-commit-subject>fix add displayed_on_home</span>
<span class=article-git-commit-time>2022-11-20 14:49</span>
<a class=article-git-source href=https://github.com/linianhui/blog/blob/main/src/java/cas/index.md target=_blank><i class="fa fa-github"></i>源码</a></section></section><section class=article-page><div class=article-page-prev><span>上一篇 : </span><a href=/java/thread/ target=_blank>[Java] Thread</a></div><div class=article-page-next><span>下一篇 : </span><a href=/java/synchronized/ target=_blank>[Java] synchronized</a></div></section></article><section id=article-comment class=article-comment><script src=https://utteranc.es/client.js repo=linianhui/blog issue-term=pathname label=blog-comment theme=github-light crossorigin=anonymous async></script></section></main><footer class=footer><section>Copyright © 2025 by <a href=https://github.com/linianhui/blog target=_blank>Timetombs</a></section><section><a class=article-git-commit href=https://github.com/linianhui/blog/commit/2fac07e818d6d4ad6b78781efea82c28769c8c02 target=_blank><i class="fa fa-code-fork"></i>2fac07e</a>
Powered by
<a href=https://github.com/actions target=_blank>GitHub Actions</a>
,
<a href=https://github.com/gohugoio/hugo target=_blank>Hugo</a>
and
<a href=https://github.com/utterance/utterances target=_blank>utterances</a>
Hosted on <a href=https://pages.github.com/ target=_blank>GitHub Pages</a><section></footer></main><aside class=toolbar><a class="fa fa-list" href=javascript:blog.toggleToc(); title=目录></a><a class="fa fa-comments" href=#article-comment title=评论></a><a class="fa fa-arrow-up" href=javascript:scroll(0,0); title=返回顶部></a></aside><script type=text/javascript>var _hmt=_hmt||[];blog.addOnScorllEvent()</script><script src=https://hm.baidu.com/hm.js?b2cc3cea316e1f7a8def1bab8dc98fad async></script></body></html>